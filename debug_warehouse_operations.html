<!DOCTYPE html>
<html>
<head>
    <title>åº“ä½æ“ä½œè°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        .important { background: #fff3cd; border-color: #ffeaa7; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .warehouse-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin: 20px 0; }
        .location-cell { padding: 10px; border: 1px solid #ddd; text-align: center; background: #f8f9fa; }
        .location-cell.has-pallet { background: #d4edda; }
        .location-cell.empty { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>åº“ä½æ“ä½œè°ƒè¯•å·¥å…·</h1>
    
    <div class="step important">
        <h2>ğŸ” é—®é¢˜è¯Šæ–­</h2>
        <p>æ‚¨æŠ¥å‘Šè¯´å‡ºå…¥åº“æ—¶ç›´æ¥æ“ä½œäº†ä¸¤ä¸ªåº“ä½ï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿã€‚è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å¯èƒ½çš„åŸå› ï¼š</p>
        <ul>
            <li>ç›‘æ§é¢‘ç‡è¿‡é«˜ï¼Œå¯¼è‡´é‡å¤å¤„ç†</li>
            <li>MESè®¢å•æ²¡æœ‰åŠæ—¶æ¸…é™¤</li>
            <li>æ•°æ®åº“äº‹åŠ¡é—®é¢˜</li>
            <li>Modbusè¿æ¥ä¸ç¨³å®š</li>
        </ul>
    </div>
    
    <div class="step">
        <h2>1. æ£€æŸ¥å½“å‰åº“ä½çŠ¶æ€</h2>
        <button onclick="checkWarehouseStatus()">æ£€æŸ¥åº“ä½çŠ¶æ€</button>
        <div id="warehouseResult" class="result" style="display:none;"></div>
        <div id="warehouseGrid" class="warehouse-grid"></div>
    </div>
    
    <div class="step">
        <h2>2. æ£€æŸ¥MES-WMSçŠ¶æ€</h2>
        <button onclick="checkMesWmsStatus()">æ£€æŸ¥MES-WMSçŠ¶æ€</button>
        <div id="mesWmsResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="step">
        <h2>3. æµ‹è¯•å‡ºåº“æ“ä½œ</h2>
        <button onclick="testOutbound()">æµ‹è¯•å‡ºåº“æ“ä½œ</button>
        <div id="outboundResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="step">
        <h2>4. æµ‹è¯•å…¥åº“æ“ä½œ</h2>
        <button onclick="testInbound()">æµ‹è¯•å…¥åº“æ“ä½œ</button>
        <div id="inboundResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="step">
        <h2>5. ç›‘æ§æ—¥å¿—</h2>
        <button onclick="startMonitoring()">å¼€å§‹ç›‘æ§</button>
        <button onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
        <div id="monitoringResult" class="result" style="display:none;"></div>
        <div id="logContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px;"></div>
    </div>
    
    <script>
        let monitoringInterval = null;
        let logCount = 0;
        
        async function checkWarehouseStatus() {
            const resultDiv = document.getElementById('warehouseResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥åº“ä½çŠ¶æ€...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/mes-wms/status');
                const data = await response.json();
                
                if (data.locationStatus) {
                    resultDiv.innerHTML = '<div class="success">âœ… åº“ä½çŠ¶æ€è·å–æˆåŠŸ</div>';
                    displayWarehouseGrid(data.locationStatus);
                } else {
                    resultDiv.innerHTML = '<div class="error">âŒ åº“ä½çŠ¶æ€è·å–å¤±è´¥</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">âŒ æ£€æŸ¥åº“ä½çŠ¶æ€æ—¶å‡ºé”™: ' + error.message + '</div>';
            }
        }
        
        function displayWarehouseGrid(locationStatus) {
            const gridDiv = document.getElementById('warehouseGrid');
            gridDiv.innerHTML = '';
            
            for (let row = 1; row <= 5; row++) {
                for (let col = 1; col <= 6; col++) {
                    const locationKey = `location${(row - 1) * 6 + col}`;
                    const hasPallet = locationStatus[locationKey] === 1;
                    
                    const cell = document.createElement('div');
                    cell.className = `location-cell ${hasPallet ? 'has-pallet' : 'empty'}`;
                    cell.innerHTML = `${row}è¡Œ${col}åˆ—<br>${hasPallet ? 'æœ‰æ–™' : 'ç©º'}`;
                    gridDiv.appendChild(cell);
                }
            }
        }
        
        async function checkMesWmsStatus() {
            const resultDiv = document.getElementById('mesWmsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æ£€æŸ¥MES-WMSçŠ¶æ€...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/mes-wms/status');
                const data = await response.json();
                
                resultDiv.innerHTML = '<div class="info">MES-WMSçŠ¶æ€:<br><pre>' + JSON.stringify(data, null, 2) + '</pre></div>';
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">âŒ æ£€æŸ¥MES-WMSçŠ¶æ€æ—¶å‡ºé”™: ' + error.message + '</div>';
            }
        }
        
        async function testOutbound() {
            const resultDiv = document.getElementById('outboundResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å‡ºåº“æ“ä½œ...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/mes-wms-flow/check-and-execute', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = '<div class="success">âœ… å‡ºåº“æ“ä½œæµ‹è¯•æˆåŠŸ<br>ç»“æœ: ' + JSON.stringify(data) + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="error">âŒ å‡ºåº“æ“ä½œæµ‹è¯•å¤±è´¥: ' + data.message + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">âŒ æµ‹è¯•å‡ºåº“æ“ä½œæ—¶å‡ºé”™: ' + error.message + '</div>';
            }
        }
        
        async function testInbound() {
            const resultDiv = document.getElementById('inboundResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å…¥åº“æ“ä½œ...</div>';
            
            try {
                const response = await fetch('http://localhost:8080/api/mes-wms-flow/check-and-execute', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = '<div class="success">âœ… å…¥åº“æ“ä½œæµ‹è¯•æˆåŠŸ<br>ç»“æœ: ' + JSON.stringify(data) + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="error">âŒ å…¥åº“æ“ä½œæµ‹è¯•å¤±è´¥: ' + data.message + '</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">âŒ æµ‹è¯•å…¥åº“æ“ä½œæ—¶å‡ºé”™: ' + error.message + '</div>';
            }
        }
        
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            const resultDiv = document.getElementById('monitoringResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">å¼€å§‹ç›‘æ§ï¼Œæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡...</div>';
            
            monitoringInterval = setInterval(async () => {
                try {
                    const response = await fetch('http://localhost:8080/api/mes-wms-flow/check-and-execute', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    const logDiv = document.getElementById('logContainer');
                    const timestamp = new Date().toLocaleTimeString();
                    logCount++;
                    
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = `[${timestamp}] #${logCount} - ${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}: ${data.message}`;
                    if (data.operation) {
                        logEntry.innerHTML += ` - æ“ä½œ: ${data.operation === 'inbound' ? 'å…¥åº“' : 'å‡ºåº“'}`;
                    }
                    if (data.row && data.column) {
                        logEntry.innerHTML += ` - ä½ç½®: ${data.row}è¡Œ${data.column}åˆ—`;
                    }
                    
                    logDiv.insertBefore(logEntry, logDiv.firstChild);
                    
                    // é™åˆ¶æ—¥å¿—æ•°é‡
                    while (logDiv.children.length > 20) {
                        logDiv.removeChild(logDiv.lastChild);
                    }
                } catch (error) {
                    console.error('ç›‘æ§å‡ºé”™:', error);
                }
            }, 3000);
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                
                const resultDiv = document.getElementById('monitoringResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div class="info">å·²åœæ­¢ç›‘æ§</div>';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkWarehouseStatus();
            checkMesWmsStatus();
        };
    </script>
</body>
</html>
